{% extends 'base.html' %}

{% block title %}Blog{% if selected_category %} - {{ selected_category.name }}{% elif selected_tag %} - {{ selected_tag.name }}{% endif %}{% endblock %}

{% block content %}
<div class="blog-container">
    <div class="container">

        <div class="blog-layout">
            <div class="blog-main">
                {% if posts.items %}
                <div class="posts-grid">
                    {% for post in posts.items %}
                    <article class="post-card">
                        {% if post.featured_image and post.featured_image.strip() %}
                        <div class="post-image">
                            <a href="{{ url_for('blog_detail', slug=post.slug) }}">
                                {% if post.featured_image.startswith('http') %}
                                <img src="{{ post.featured_image }}" alt="{{ post.title }}" onerror="this.parentElement.parentElement.innerHTML='<div class=\\'post-image\\' style=\\'background: var(--gradient-soft); display: flex; align-items: center; justify-content: center; color: var(--primary-color); font-size: 3rem; font-weight: 700;\\'>{{ post.title[0] }}</div>'">
                                {% else %}
                                <img src="{{ url_for('uploaded_file', file_type='images', filename=post.featured_image) }}" alt="{{ post.title }}" onerror="this.parentElement.parentElement.innerHTML='<div class=\\'post-image\\' style=\\'background: var(--gradient-soft); display: flex; align-items: center; justify-content: center; color: var(--primary-color); font-size: 3rem; font-weight: 700;\\'>{{ post.title[0] }}</div>'">
                                {% endif %}
                            </a>
                        </div>
                        {% else %}
                        <div class="post-image" style="background: var(--gradient-soft); display: flex; align-items: center; justify-content: center; color: var(--primary-color); font-size: 3rem; font-weight: 700;">
                            {{ post.title[0] }}
                        </div>
                        {% endif %}
                        <div class="post-content">
                            <div class="post-meta">
                                {% if post.category %}
                                <a href="{{ url_for('blog_category', slug=post.category.slug) }}" class="post-category">
                                    {{ post.category.name }}
                                </a>
                                {% endif %}
                                <span class="post-date">
                                    {{ post.published_date.strftime('%b %d, %Y') if post.published_date else post.created_date.strftime('%b %d, %Y') }}
                                </span>
                            </div>
                            <h2 class="post-title">
                                <a href="{{ url_for('blog_detail', slug=post.slug) }}">{{ post.title }}</a>
                            </h2>
                            <p class="post-excerpt">{{ post.excerpt[:150] if post.excerpt else (post.content[:150]|striptags) }}...</p>
                            <div class="post-footer">
                                <div class="post-tags">
                                    {% for tag in post.tags %}
                                    <a href="{{ url_for('blog_tag', slug=tag.slug) }}" class="tag-link">{{ tag.name }}</a>
                                    {% endfor %}
                                </div>
                                <a href="{{ url_for('blog_detail', slug=post.slug) }}" class="read-more">Read More →</a>
                            </div>
                        </div>
                    </article>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if posts.pages > 1 %}
                <div class="pagination">
                    {% if posts.has_prev %}
                    <a href="{{ url_for('blog_list', page=posts.prev_num, category=selected_category.slug if selected_category else None, tag=selected_tag.slug if selected_tag else None, search=search_query) }}" class="pagination-link">← Previous</a>
                    {% endif %}
                    
                    <span class="pagination-info">
                        Page {{ posts.page }} of {{ posts.pages }}
                    </span>
                    
                    {% if posts.has_next %}
                    <a href="{{ url_for('blog_list', page=posts.next_num, category=selected_category.slug if selected_category else None, tag=selected_tag.slug if selected_tag else None, search=search_query) }}" class="pagination-link">Next →</a>
                    {% endif %}
                </div>
                {% endif %}
                {% else %}
                <div class="no-posts">
                    <p>No blog posts found.</p>
                    {% if search_query %}
                    <p>Try a different search term.</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <aside class="blog-sidebar">
                <div class="sidebar-widget">
                    <h3>Search</h3>
                    <form method="get" action="{{ url_for('blog_list') }}" class="search-form">
                        <input type="text" name="search" placeholder="Search posts..." value="{{ search_query or '' }}">
                        <button type="submit" class="btn btn-small">Search</button>
                    </form>
                </div>

                <div class="sidebar-widget">
                    <h3>Categories</h3>
                    <ul class="category-list">
                        <li><a href="{{ url_for('blog_list') }}">All Categories</a></li>
                        {% for category in categories %}
                        <li>
                            <a href="{{ url_for('blog_category', slug=category.slug) }}" 
                               {% if selected_category and selected_category.slug == category.slug %}class="active"{% endif %}>
                                {{ category.name }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="sidebar-widget">
                    <h3>Tags</h3>
                    <div class="tags-cloud">
                        {% for tag in tags %}
                        <a href="{{ url_for('blog_tag', slug=tag.slug) }}" 
                           class="tag-link {% if selected_tag and selected_tag.slug == tag.slug %}active{% endif %}">
                            {{ tag.name }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </aside>
        </div>
    </div>
</div>
{% endblock %}

